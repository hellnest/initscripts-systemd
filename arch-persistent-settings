#!/bin/bash
#
# /lib/systemd/arch-settings
#

. /etc/rc.conf

# Update timezone if: The timezone is set in rc.conf, the corresponding zoneinfo file exists and rc.conf has been changed since the timezone was last updated
if [[ "$TIMEZONE" != "" && -e "/usr/share/zoneinfo/$TIMEZONE" && "/etc/rc.conf" -nt "/etc/localtime" ]]; then
	/bin/rm -f /etc/localtime
	/bin/cp "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
fi

# Adding persistent network/cdrom generated rules (this should probably be done differently, upstream specifically recomends against relying on /dev/.udev)
if [ -f "/dev/.udev/tmp-rules--70-persistent-cd.rules" ]; then
	/bin/cat /dev/.udev/tmp-rules--70-persistent-cd.rules >> /etc/udev/rules.d/70-persistent-cd.rules
fi
if [ -f "/dev/.udev/tmp-rules--70-persistent-net.rules" ]; then
	/bin/cat /dev/.udev/tmp-rules--70-persistent-net.rules >> /etc/udev/rules.d/70-persistent-net.rules
fi

# Build module blacklist if rc.conf has been updated since blacklist.sys.conf was last updated
if [[ "/etc/rc.conf" -nt "/etc/modprobe.d/blacklist.sys.conf" ]]; then

	BLACKLIST="${MOD_BLACKLIST[@]}"

	#MODULES entries in rc.conf that begin with ! are blacklisted
	for mod in ${MODULES[@]}; do
		if [ "${mod}" != "${mod#!}" ]; then
			BLACKLIST="$BLACKLIST ${mod#!}"
		fi
	done

	/bin/mkdir -p /etc/modprobe.d
	echo "# Autogenerated by systemd, do not edit" > /etc/modprobe.d/blacklist.sys.conf

	for d in ${BLACKLIST}; do
		echo "install ${d} /bin/false" >> /etc/modprobe.d/blacklist.sys.conf
	done

	unset BLACKLIST

fi


# Build module blacklist if rc.conf has been updated since blacklist.sys.conf was last updated
if [[ "/etc/rc.conf" -nt "/etc/modules-load.d/rc.conf" ]]; then

	MODS=""

	#MODULES entries in rc.conf that begin with ! are blacklisted
	for mod in ${MODULES[@]}; do
		if [ "${mod}" == "${mod#!}" ]; then
			MODS="$MODS ${mod#!}"
		fi
	done

	/bin/mkdir -p /etc/modules-load.d
	echo "# Autogenerated by systemd, do not edit" > /etc/modules-load.d/rc.conf

	for d in ${MODS}; do
		echo "${d}" >> /etc/modules-load.d/rc.conf
	done

	unset MODS
fi
