#!/bin/bash
#
# /lib/systemd/arch-settings
#

. /etc/rc.conf

# Update timezone if: The timezone is set in rc.conf and the corresponding
# zoneinfo file exists
if [[ -n $TIMEZONE && -f /usr/share/zoneinfo/$TIMEZONE ]]; then
	/bin/cp --remove-destination "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
fi

# Adding persistent network/cdrom generated rules (this should probably be done
# differently, upstream specifically recomends against relying on /dev/.udev)
for rulesfile in 70-persistent-{cd,net}.rules; do
	if [[ -f /dev/.udev/tmp-rules--$rulesfile ]]; then
		/bin/cat /dev/.udev/tmp-rules--$rulesfile >> /etc/udev/rules.d/$rulesfile
	fi
done

declare -a modules blacklist
for mod in "${MODULES[@]}"; do
	case $mod in
		!*) blacklist+=("${mod:1}") ;;
		*) modules+=("$mod") ;;
	esac
done

# Build module blacklist if rc.conf has been updated since blacklist.sys.conf
# was last updated
if [[ /etc/rc.conf -nt /etc/modprobe.d/rc.conf ]]; then
	echo "# Autogenerated by systemd, do not edit" > /etc/modprobe.d/rc.conf 
	(( ${#blacklist[@]} )) && printf 'install %s /bin/false\n' "${blacklist[@]}" >> /etc/modprobe.d/rc.conf
fi

# Build module list if rc.conf has been updated since modules-load.d/rc.conf
# was last updated
if [[ /etc/rc.conf -nt /etc/modules-load.d/rc.conf ]]; then
	echo "# Autogenerated by systemd, do not edit" > /etc/modules-load.d/rc.conf 
	printf '%s\n' "${modules[@]}" >> /etc/modules-load.d/rc.conf
fi

unset blacklist modules

# vim: set noet ts=2 sw=2:
