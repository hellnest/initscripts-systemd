#!/bin/bash
#
# /lib/systemd/arch-settings
#

. /etc/rc.conf

# Update timezone if: The timezone is set in rc.conf, the corresponding
# zoneinfo file exists and rc.conf has been changed since the timezone was last
# updated
if [[ -f /usr/share/zoneinfo/$TIMEZONE && /etc/rc.conf -nt /etc/localtime ]]; then
	/bin/rm -f /etc/localtime
	/bin/cp "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
fi

# Adding persistent network/cdrom generated rules (this should probably be done
# differently, upstream specifically recomends against relying on /dev/.udev)
if [[ -f /dev/.udev/tmp-rules--70-persistent-cd.rules ]]; then
	/bin/cat /dev/.udev/tmp-rules--70-persistent-cd.rules >> \
		/etc/udev/rules.d/70-persistent-cd.rules
fi
if [[ -f /dev/.udev/tmp-rules--70-persistent-net.rules ]]; then
	/bin/cat /dev/.udev/tmp-rules--70-persistent-net.rules >> \
		/etc/udev/rules.d/70-persistent-net.rules
fi

# Build module blacklist if rc.conf has been updated since blacklist.sys.conf
# was last updated
if [[ /etc/rc.conf -nt /etc/modprobe.d/blacklist.sys.conf ]]; then

	/bin/mkdir -p /etc/modprobe.d
	echo "# Autogenerated by systemd, do not edit" > /etc/modprobe.d/blacklist.sys.conf

	# these _cannot_ be quoted
	for mod in ${MOD_BLACKLIST[@]} ${MODULES[@]/#[^!]*}; do
		echo "install ${mod#!} /bin/false" >> /etc/modprobe.d/blacklist.sys.conf
	done

fi

# Build module list if rc.conf has been updated since modules-load.d/rc.conf
# was last updated
if [[ /etc/rc.conf -nt /etc/modules-load.d/rc.conf ]]; then

	/bin/mkdir -p /etc/modules-load.d
	echo "# Autogenerated by systemd, do not edit" > /etc/modules-load.d/rc.conf

	# these _cannot_ be quoted
	for mod in ${MODULES[@]/#!*}; do
		echo "$mod" >> /etc/modules-load.d/rc.conf
	done

fi

# vim: set noet ts=2 sw=2:
